from aiogram import Router, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
import logging

router = Router()
logger = logging.getLogger(__name__)

@router.message(Command("start"))
async def start_command(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø—Ä–æ—Å–∞
    current_state = await state.get_state()
    if current_state is not None:
        await message.answer(
            "‚è≥ *–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ –æ—Ü–µ–Ω–∫—É –ø–∏—Ç–∞–Ω–∏—è!*\n\n"
            "–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –æ—Ü–µ–Ω–∫—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /reset —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
            parse_mode="Markdown"
        )
        return
    
    welcome_text = """
üçΩÔ∏è *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –æ—Ü–µ–Ω–∫–∏ —à–∫–æ–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è!*

–Ø –ø–æ–º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å –≤–∞—à–∏ –æ—Ç–∑—ã–≤—ã –æ –ø–∏—Ç–∞–Ω–∏–∏ –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π. –í–∞—à–µ –º–Ω–µ–Ω–∏–µ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ø–∏—Ç–∞–Ω–∏—è!

üìä *–ß—Ç–æ —è —É–º–µ—é:*
‚Ä¢ –°–æ–±–∏—Ä–∞—Ç—å –≤–∞—à–∏ –æ—Ü–µ–Ω–∫–∏ –±–ª—é–¥
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏  
‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å —Å–¥–µ–ª–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –≤ —à–∫–æ–ª–µ –ª—É—á—à–µ!

üéØ *–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*
1. –û—Ç–≤–µ—Ç–∏—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤
2. –û—Ü–µ–Ω–∏—Ç–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –±–ª—é–¥–∞
3. –û—Å—Ç–∞–≤–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ)

üîÑ *–ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:*
–ï—Å–ª–∏ –≤—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –æ–ø—Ä–æ—Å —Å–µ–≥–æ–¥–Ω—è, –Ω–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ - –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–π–¥–∏—Ç–µ –æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ!

üõë *–ö–æ–º–∞–Ω–¥—ã:*
/mark - –Ω–∞—á–∞—Ç—å –æ—Ü–µ–Ω–∫—É –ø–∏—Ç–∞–Ω–∏—è
/reset - —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –æ–ø—Ä–æ—Å
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)

üìù *–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:*
–í—Å–µ –æ—Ç–≤–µ—Ç—ã –∞–Ω–æ–Ω–∏–º–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è.

*–ù–∞—á–Ω–µ–º?* ‚ú®

–ü—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /mark —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ü–µ–Ω–∫—É!
    """
    
    await message.answer(
        text=welcome_text,
        parse_mode="Markdown"
    )

@router.message(Command("reset"))
async def reset_command(message: types.Message, state: FSMContext):
    """–°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –æ–ø—Ä–æ—Å–∞"""
    current_state = await state.get_state()
    
    if current_state is None:
        await message.answer(
            "‚ÑπÔ∏è *–°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞.*\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /mark —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É –ø–∏—Ç–∞–Ω–∏—è.",
            parse_mode="Markdown"
        )
        return
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()
    
    # –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é user_id
    from callbacks.type_callback import current_user_id
    global current_user_id
    current_user_id = None
    
    await message.answer(
        "üîÑ *–û–ø—Ä–æ—Å —Å–±—Ä–æ—à–µ–Ω!*\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /mark",
        parse_mode="Markdown"
    )
    logger.info(f"–û–ø—Ä–æ—Å —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")